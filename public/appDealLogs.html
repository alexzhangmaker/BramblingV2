<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deal Logs Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        console: {
                            bg: '#1e1e1e',
                            sidebar: '#252526',
                            header: '#333333',
                            border: '#3e3e42',
                            text: '#cccccc',
                            accent: '#0e639c', // VS Code Blue
                            green: '#4ec9b0',
                            yellow: '#dcdcaa',
                            red: '#f44747'
                        }
                    },
                    fontFamily: {
                        mono: ['"Fira Code"', 'Consolas', 'Monaco', '"Courier New"', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .font-mono {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }
    </style>
</head>

<body class="bg-console-bg text-console-text h-screen flex flex-col overflow-hidden">

    <!-- Top Toolbar -->
    <header class="h-10 bg-console-header flex items-center px-4 border-b border-console-border select-none">
        <div class="flex items-center space-x-2 text-sm">
            <span class="font-bold text-gray-200">Deal Logs Manager</span>
            <span class="text-gray-500">|</span>
            <button onclick="refreshData()"
                class="hover:bg-console-border px-2 py-1 rounded transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
                Refresh
            </button>
        </div>
        <div class="flex-1"></div>
        <div class="text-xs text-gray-400">
            Connected to: localhost:3000
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Left Sidebar -->
        <aside
            class="w-16 bg-console-sidebar flex flex-col items-center py-4 border-r border-console-border hidden md:flex">
            <button class="p-3 mb-2 rounded hover:bg-console-header text-gray-400 hover:text-white" title="Logs">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
            </button>
            <button class="p-3 mb-2 rounded hover:bg-console-header text-gray-400 hover:text-white"
                title="Settings (Mock)">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </aside>

        <!-- Main Content (Right) -->
        <main class="flex-1 flex flex-col bg-console-bg">

            <!-- Filters Setup -->
            <div class="p-4 border-b border-console-border bg-console-bg flex flex-wrap gap-4 items-end">
                <!-- Search Ticker -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1 uppercase tracking-wider font-semibold">Ticker
                        Search</label>
                    <div class="relative">
                        <input type="text" id="filterTicker" placeholder="e.g. TSLA"
                            class="bg-console-header text-gray-200 text-sm rounded border border-console-border px-3 py-1.5 w-40 focus:outline-none focus:border-console-accent font-mono">
                    </div>
                </div>

                <!-- Currency Filter -->
                <div>
                    <label
                        class="block text-xs text-gray-500 mb-1 uppercase tracking-wider font-semibold">Currency</label>
                    <select id="filterCurrency"
                        class="bg-console-header text-gray-200 text-sm rounded border border-console-border px-3 py-1.5 w-32 focus:outline-none focus:border-console-accent">
                        <option value="">All</option>
                        <option value="USD">USD</option>
                        <option value="HKD">HKD</option>
                        <option value="CNY">CNY</option>
                    </select>
                </div>

                <!-- Action Filter -->
                <div>
                    <label
                        class="block text-xs text-gray-500 mb-1 uppercase tracking-wider font-semibold">Action</label>
                    <select id="filterAction"
                        class="bg-console-header text-gray-200 text-sm rounded border border-console-border px-3 py-1.5 w-32 focus:outline-none focus:border-console-accent">
                        <option value="">All</option>
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                        <option value="DEPOSIT">DEPOSIT</option>
                        <option value="WITHDRAW">WITHDRAW</option>
                        <option value="DIVIDEND">DIVIDEND</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div>
                    <label
                        class="block text-xs text-gray-500 mb-1 uppercase tracking-wider font-semibold">Status</label>
                    <select id="filterStatus"
                        class="bg-console-header text-gray-200 text-sm rounded border border-console-border px-3 py-1.5 w-32 focus:outline-none focus:border-console-accent">
                        <option value="">All</option>
                        <option value="toAudit">To Audit</option>
                        <option value="audited">Audited</option>
                    </select>
                </div>
            </div>

            <!-- Table Area -->
            <div class="flex-1 overflow-auto p-4">
                <table class="w-full text-left border-collapse text-sm text-gray-300 font-mono">
                    <thead class="bg-console-header text-xs text-gray-400 uppercase sticky top-0">
                        <tr>
                            <th class="px-4 py-2 border-b border-console-border w-16 text-center">ID</th>
                            <th class="px-4 py-2 border-b border-console-border w-24">Date</th>
                            <th class="px-4 py-2 border-b border-console-border w-20">Action</th>
                            <th class="px-4 py-2 border-b border-console-border w-24">Ticker</th>
                            <th class="px-4 py-2 border-b border-console-border text-right w-24">Amount</th>
                            <th class="px-4 py-2 border-b border-console-border text-right w-24">Price</th>
                            <th class="px-4 py-2 border-b border-console-border w-20 pl-4">CCY</th>
                            <th class="px-4 py-2 border-b border-console-border text-right w-32">Total</th>
                            <th class="px-4 py-2 border-b border-console-border w-24 text-center">Status</th>
                            <th class="px-4 py-2 border-b border-console-border">Raw Log / Actions</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody" class="divide-y divide-console-border">
                        <!-- Data injected via JS -->
                    </tbody>
                </table>

                <div id="loading" class="text-center py-10 text-gray-500 hidden">
                    Loading data...
                </div>
                <div id="noData" class="text-center py-10 text-gray-500 hidden">
                    No matching records found.
                </div>
            </div>

            <!-- Footer Stats -->
            <div
                class="h-8 bg-console-sidebar border-t border-console-border flex items-center px-4 text-xs text-gray-500 space-x-4">
                <span id="totalCount">Total: 0</span>
                <span id="filteredCount">Showing: 0</span>
            </div>

            <!-- Sticky Input Bar -->
            <div class="p-4 bg-console-sidebar border-t border-console-border sticky bottom-0 z-10 shadow-lg">
                <div class="flex gap-2">
                    <input type="text" id="newDealInput"
                        placeholder="Type a natural language deal (e.g., 'Sold 500 AAPL at 180.5 USD for total 90250')"
                        class="flex-1 bg-console-bg text-gray-200 border border-console-border rounded px-4 py-2 focus:outline-none focus:border-console-accent font-mono text-sm"
                        onkeypress="if(event.key === 'Enter') submitNewDeal()">
                    <button onclick="submitNewDeal()"
                        class="bg-console-accent hover:bg-blue-600 text-white px-6 py-2 rounded text-sm font-semibold transition-colors flex items-center gap-2">
                        <span>Parser & Save</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Script -->
    <script>
        let allLogs = [];

        async function fetchLogs() {
            const loading = document.getElementById('loading');
            const noData = document.getElementById('noData');
            const tbody = document.getElementById('logsTableBody');

            loading.classList.remove('hidden');
            noData.classList.add('hidden');
            tbody.innerHTML = '';

            try {
                const response = await fetch('/api/deals');
                const result = await response.json();

                if (result.success) {
                    allLogs = result.data;
                    renderTable(allLogs);
                } else {
                    console.error('Failed to fetch:', result.error);
                }
            } catch (error) {
                console.error('Network Error:', error);
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderTable(logs) {
            const tbody = document.getElementById('logsTableBody');
            const noData = document.getElementById('noData');
            const filterTicker = document.getElementById('filterTicker').value.toUpperCase();
            const filterCurrency = document.getElementById('filterCurrency').value;
            const filterAction = document.getElementById('filterAction').value;
            const filterStatus = document.getElementById('filterStatus').value;

            // Apply Filters
            const filtered = logs.filter(log => {
                const matchesTicker = !filterTicker || (log.ticker && log.ticker.includes(filterTicker));
                const matchesCurrency = !filterCurrency || log.currency === filterCurrency;
                const matchesAction = !filterAction || log.action === filterAction;
                const matchesStatus = !filterStatus || log.status === filterStatus;
                return matchesTicker && matchesCurrency && matchesAction && matchesStatus;
            });

            // Update Stats
            document.getElementById('totalCount').textContent = `Total: ${logs.length}`;
            document.getElementById('filteredCount').textContent = `Showing: ${filtered.length}`;

            tbody.innerHTML = '';

            if (filtered.length === 0) {
                noData.classList.remove('hidden');
                return;
            } else {
                noData.classList.add('hidden');
            }

            filtered.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-console-header transition-colors group';

                // Status Badge Color
                let statusColor = 'text-gray-400 border-gray-500';
                if (log.status === 'toAudit') statusColor = 'text-yellow-400 border-yellow-500 bg-yellow-900/20';
                if (log.status === 'audited') statusColor = 'text-green-400 border-green-500 bg-green-900/20';

                // Format numbers
                const fmtAmount = log.amount ? log.amount.toLocaleString() : '-';
                const fmtPrice = log.price ? log.price.toFixed(4) : '-';
                const fmtTotal = log.total ? log.total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-';
                const date = log.date || '-';

                tr.innerHTML = `
                    <td class="px-4 py-2 border-r border-console-border text-center text-gray-500 text-xs">${log.id}</td>
                    <td class="px-4 py-2 text-console-text">${date}</td>
                    <td class="px-4 py-2 font-bold text-console-accent">${log.action || '?'}</td>
                    <td class="px-4 py-2 font-bold text-white">${log.ticker || '?'}</td>
                    <td class="px-4 py-2 text-right">${fmtAmount}</td>
                    <td class="px-4 py-2 text-right text-gray-400">${fmtPrice}</td>
                    <td class="px-4 py-2 text-gray-400 border-r border-console-border pl-4">${log.currency || '?'}</td>
                    <td class="px-4 py-2 text-right font-semibold text-gray-200 border-r border-console-border">${fmtTotal}</td>
                    <td class="px-4 py-2 text-center border-r border-console-border">
                        <span class="text-xs px-2 py-0.5 rounded border ${statusColor}">${log.status}</span>
                    </td>
                    <td class="px-4 py-2 flex items-center justify-between">
                        <span class="text-xs text-gray-600 truncate max-w-[200px]" title="${log.rawText}">${log.rawText || ''}</span>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                 ${log.status === 'toAudit' ?
                        `<button onclick="auditLog(${log.id})" class="text-xs bg-console-green text-black px-2 py-1 rounded hover:bg-white transition">Verify</button>`
                        : ''}
                                ${log.status !== 'audited' ?
                        `<button onclick="deleteLog(${log.id})" class="text-xs bg-console-red text-white px-2 py-1 rounded hover:bg-red-400 transition">Del</button>`
                        : ''}
                            </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function auditLog(id) {
            if (!confirm('Mark this record as Audited?')) return;
            try {
                const res = await fetch(`/api/deals/${id}/audit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const json = await res.json();
                if (json.success) {
                    fetchLogs(); // Reload
                } else {
                    alert('Error: ' + json.error);
                }
            } catch (e) {
                alert('Request failed');
            }
        }

        async function deleteLog(id) {
            if (!confirm(`Are you sure you want to delete log ID ${id}?`)) return;
            try {
                const res = await fetch(`/api/deals/${id}`, {
                    method: 'DELETE'
                });
                const json = await res.json();
                if (json.success) {
                    fetchLogs(); // Reload
                } else {
                    alert('Error: ' + json.error);
                }
            } catch (e) {
                alert('Request failed');
            }
        }

        function refreshData() {
            fetchLogs();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchLogs();

            // Attach Filter Listeners
            ['filterTicker', 'filterCurrency', 'filterAction', 'filterStatus'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => renderTable(allLogs));
            });
        });

        async function submitNewDeal() {
            const input = document.getElementById('newDealInput');
            const text = input.value.trim();
            if (!text) return;

            // Show loading state
            const btn = document.querySelector('button[onclick="submitNewDeal()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>Processing...</span>';
            btn.disabled = true;

            try {
                const res = await fetch('/api/log-deal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const json = await res.json();

                if (json.success) {
                    input.value = ''; // Clear input
                    fetchLogs(); // Reload data
                    // Optional: Scroll to top or highlight new item
                } else {
                    alert('Error: ' + json.error);
                }
            } catch (e) {
                console.error(e);
                alert('Request failed');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

    </script>
</body>

</html>