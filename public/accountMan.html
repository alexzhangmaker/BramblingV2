<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ„äº§ç»„åˆç®¡ç†ç³»ç»Ÿæ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        html{
            font-size: 16px; /* 1rem = 16px */
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 20px;
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .stat-card .label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .table-actions {
            white-space: nowrap;
        }
        
        .search-box {
            max-width: 300px;
        }
        
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
    </style>
    <style>
        header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ“Š äº¤æ˜“è®°å½•ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="auth-section">
            <div id="login-form">
                <input type="email" id="email" placeholder="Gmailé‚®ç®±" value="alexszhang@gmail.com">
                <input type="password" id="password" placeholder="å¯†ç ">
                <button onclick="login()">ç™»å½•</button>
            </div>
            <div id="user-info" style="display: none;">
                <span id="user-email"></span>
                <button onclick="logout()">é€€å‡º</button>
            </div>
        </div>
    </header>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar col-md-2">
        <div class="text-center mb-4">
            <h4><i class="fas fa-chart-line"></i> èµ„äº§ç®¡ç†ç³»ç»Ÿ</h4>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link active" href="#" data-table="overview">
                <i class="fas fa-tachometer-alt"></i> æ¦‚è§ˆ
            </a>
            <a class="nav-link" href="#" data-table="account_IB7075">
                <i class="fas fa-folder"></i> IB_7075
            </a>
            <a class="nav-link" href="#" data-table="account_IB1279">
                <i class="fas fa-folder"></i> IB_1279
            </a>
            <a class="nav-link" href="#" data-table="portfolios">
                <i class="fas fa-folder"></i> æŠ•èµ„ç»„åˆ
            </a>
            <a class="nav-link" href="#" data-table="assets">
                <i class="fas fa-chart-bar"></i> èµ„äº§ä¿¡æ¯
            </a>
            <a class="nav-link" href="#" data-table="holdings">
                <i class="fas fa-coins"></i> æŒä»“è®°å½•
            </a>
            <a class="nav-link" href="#" data-table="transactions">
                <i class="fas fa-exchange-alt"></i> äº¤æ˜“è®°å½•
            </a>
            <a class="nav-link" href="#" data-table="asset_prices">
                <i class="fas fa-dollar-sign"></i> èµ„äº§ä»·æ ¼
            </a>
            <a class="nav-link" href="#" data-table="exchange_rates">
                <i class="fas fa-globe"></i> æ±‡ç‡æ•°æ®
            </a>
            <a class="nav-link" href="#" data-table="balance_sheets">
                <i class="fas fa-balance-scale"></i> èµ„äº§è´Ÿå€ºè¡¨
            </a>
            <a class="nav-link" href="#" data-table="asset_classifications">
                <i class="fas fa-tags"></i> èµ„äº§åˆ†ç±»
            </a>
        </nav>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content col-md-10">
        <!-- æ¦‚è§ˆé¡µé¢ -->
        <div id="overview-page" class="page-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tachometer-alt me-2"></i>ç³»ç»Ÿæ¦‚è§ˆ</h2>
                <button class="btn btn-primary" onclick="refreshOverview()">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                </button>
            </div>
            
            <div class="row" id="stats-container">
                <!-- ç»Ÿè®¡æ•°æ®å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">æœ€è¿‘äº¤æ˜“</h5>
                        </div>
                        <div class="card-body">
                            <div id="recent-transactions">
                                <!-- æœ€è¿‘äº¤æ˜“æ•°æ® -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">ç»„åˆåˆ†å¸ƒ</h5>
                        </div>
                        <div class="card-body">
                            <div id="portfolio-distribution">
                                <!-- ç»„åˆåˆ†å¸ƒå›¾è¡¨ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¡¨ç®¡ç†é¡µé¢ -->
        <div id="table-management-page" class="page-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="table-title"></h2>
                <div>
                    <button class="btn btn-success" onclick="showAddModal()">
                        <i class="fas fa-plus"></i> æ·»åŠ è®°å½•
                    </button>
                    <button class="btn btn-primary" onclick="refreshTable()">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                </div>
            </div>

            <div class="table-container">
                <div class="d-flex justify-content-between mb-3">
                    <div class="search-box">
                        <input type="text" id="search-input" class="form-control" placeholder="æœç´¢...">
                    </div>
                    <div>
                        <select id="page-size" class="form-select" style="width: auto;">
                            <option value="10">10æ¡/é¡µ</option>
                            <option value="25">25æ¡/é¡µ</option>
                            <option value="50">50æ¡/é¡µ</option>
                            <option value="100">100æ¡/é¡µ</option>
                        </select>
                    </div>
                </div>

                <div class="loading" id="table-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2">åŠ è½½æ•°æ®ä¸­...</p>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="data-table">
                        <thead id="table-header">
                            <!-- è¡¨å¤´å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </thead>
                        <tbody id="table-body">
                            <!-- è¡¨æ•°æ®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>

                <div class="pagination-container">
                    <div id="table-info"></div>
                    <nav>
                        <ul class="pagination" id="pagination">
                            <!-- åˆ†é¡µå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="recordModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">æ·»åŠ è®°å½•</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recordForm">
                        <div id="form-fields">
                            <!-- è¡¨å•å­—æ®µå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveButton" onclick="saveRecord()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¡®è®¤åˆ é™¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>

    <script>
        let supabase = null;
        let currentUser = null;

// åˆå§‹åŒ–åº”ç”¨
async function initFirebaseApp() {
    try {
        console.log('ğŸš€ åˆå§‹åŒ–åº”ç”¨...');
        
        // æ£€æŸ¥é…ç½®
        if (!SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey) {
            showError('è¯·å…ˆåœ¨ config.js ä¸­é…ç½® Supabase URL å’Œ Anon Key');
            return;
        }

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        console.log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„ä¼šè¯
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
            console.error('ä¼šè¯æ£€æŸ¥é”™è¯¯:', sessionError);
            showLoginForm();
            return;
        }
        
        if (session) {
            console.log('âœ… æ‰¾åˆ°å·²ä¿å­˜çš„ä¼šè¯');
            currentUser = session.user;
            showUserInfo();
            showContent();
        } else {
            console.log('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°å·²ä¿å­˜çš„ä¼šè¯');
            showLoginForm();
        }
        
        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('è®¤è¯çŠ¶æ€å˜åŒ–:', event);
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                showUserInfo();
                showContent();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                showLoginForm();
                hideContent();
            }
        });
        
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
    }
}
// ç™»å½•å‡½æ•°
async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        showError('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ Gmail é‚®ç®±
    if (!email.endsWith('@gmail.com')) {
        showError('åªå…è®¸ Gmail é‚®ç®±ç™»å½•');
        return;
    }
    
    showLoading(true);
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        showUserInfo();
        showContent();
        showSuccess('ç™»å½•æˆåŠŸï¼');
        
    } catch (error) {
        showError('ç™»å½•å¤±è´¥: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// é€€å‡ºç™»å½•
async function logout() {
    const { error } = await supabase.auth.signOut();
    if (error) {
        showError('é€€å‡ºå¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤º/éšè—ç•Œé¢å…ƒç´ 
function showLoginForm() {
    //document.getElementById('login-form').style.display = 'flex';
    //document.getElementById('user-info').style.display = 'none';
}

function showUserInfo() {
    //document.getElementById('login-form').style.display = 'none';
    //document.getElementById('user-info').style.display = 'flex';
    //document.getElementById('user-email').textContent = currentUser.email;
}

function showContent() {
    //document.getElementById('content').style.display = 'block';
}

function hideContent() {
    //document.getElementById('content').style.display = 'none';
}

function showLoading(show) {
    //document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showError(message) {
    console.log(`error ${message}`) ;
    /*
    const errorEl = document.getElementById('error-message');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => errorEl.style.display = 'none', 5000);
    */
}

function showSuccess(message) {
    console.log(`showSuccess ${message}`) ;

    /*
    const successEl = document.createElement('div');
    successEl.className = 'success';
    successEl.textContent = message;
    document.querySelector('.container').insertBefore(successEl, document.getElementById('content'));
    setTimeout(() => successEl.remove(), 3000);
    */
}
    </script>
    <script>
        // é…ç½®ä¿¡æ¯
        const CONFIG = {
            supabaseUrl: SUPABASE_CONFIG.url,
            supabaseKey: SUPABASE_CONFIG.anonKey,
            tables: {
                account_IB7075: { name: 'account_IB7075', fields: ['ticker', 'holding', 'costPerShare', 'currency', 'quoteType','exchange'] },
                account_IB1279: { name: 'account_IB1279', fields: ['ticker', 'holding', 'costPerShare', 'currency', 'quoteType','exchange'] },

                portfolios: { name: 'æŠ•èµ„ç»„åˆ', fields: ['id', 'user_id', 'name', 'description', 'base_currency'] },
                assets: { name: 'èµ„äº§ä¿¡æ¯', fields: ['id', 'symbol', 'name', 'asset_type', 'currency', 'exchange', 'sector'] },
                holdings: { name: 'æŒä»“è®°å½•', fields: ['id', 'portfolio_id', 'asset_id', 'quantity', 'average_cost', 'current_value'] },
                transactions: { name: 'äº¤æ˜“è®°å½•', fields: ['id', 'portfolio_id', 'asset_id', 'transaction_type', 'quantity', 'price', 'transaction_date'] },
                asset_prices: { name: 'èµ„äº§ä»·æ ¼', fields: ['id', 'asset_id', 'price', 'currency', 'price_date'] },
                exchange_rates: { name: 'æ±‡ç‡æ•°æ®', fields: ['id', 'from_currency', 'to_currency', 'rate', 'rate_date'] },
                balance_sheets: { name: 'èµ„äº§è´Ÿå€ºè¡¨', fields: ['id', 'portfolio_id', 'snapshot_date', 'name'] },
                asset_classifications: { name: 'èµ„äº§åˆ†ç±»', fields: ['id', 'asset_id', 'classification', 'status', 'confidence_score'] }
            },
            currentTable: null,
            currentPage: 1,
            pageSize: 10,
            totalRecords: 0,
            editingRecord: null
        };

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            initFirebaseApp() ;
            initializeApp();
        });

        function initializeApp() {
            // è®¾ç½®ä¾§è¾¹æ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // æ›´æ–°æ´»è·ƒçŠ¶æ€
                    document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tableName = this.getAttribute('data-table');
                    if (tableName === 'overview') {
                        showOverview();
                    } else {
                        showTableManagement(tableName);
                    }
                });
            });

            // è®¾ç½®æœç´¢å’Œåˆ†é¡µäº‹ä»¶
            document.getElementById('search-input').addEventListener('input', debounce(refreshTable, 300));
            document.getElementById('page-size').addEventListener('change', function() {
                CONFIG.pageSize = parseInt(this.value);
                CONFIG.currentPage = 1;
                refreshTable();
            });

            // æ˜¾ç¤ºæ¦‚è§ˆé¡µé¢
            showOverview();
        }

        function showOverview() {
            document.getElementById('overview-page').style.display = 'block';
            document.getElementById('table-management-page').style.display = 'none';
            refreshOverview();
        }

        function showTableManagement(tableName) {
            document.getElementById('overview-page').style.display = 'none';
            document.getElementById('table-management-page').style.display = 'block';
            
            CONFIG.currentTable = tableName;
            document.getElementById('table-title').textContent = CONFIG.tables[tableName].name;
            
            refreshTable();
        }

        // æ•°æ®æ“ä½œå‡½æ•°
        async function fetchData(endpoint, params = {}) {
            // è¿™é‡Œåº”è¯¥æ›¿æ¢ä¸ºå®é™…çš„Supabase APIè°ƒç”¨
            // ç”±äºæ— æ³•ç›´æ¥è®¿é—®æ‚¨çš„Supabaseå®ä¾‹ï¼Œè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            const accountCall = async(accountTbl) =>{
                let { data: jsonTblData, error } = await supabase.from(`${accountTbl}`).select('*') ;
                let dataReturn = {
                    data: jsonTblData,
                    total: jsonTblData.length/*,
                    page,
                    pageSize*/
                } ;
                return dataReturn ;
            } ;
            const dataFunction={
                "account_IB7075":accountCall,
                "account_IB1279":accountCall
            };

            let dataCall = dataFunction[endpoint] ;
            if(dataCall){
                let data = await dataCall(endpoint) ;
                return data ;
            }


            return new Promise((resolve) => {
                setTimeout(() => {
                    // æ¨¡æ‹ŸAPIå“åº”
                    const mockData = generateMockData(endpoint, params);
                    resolve(mockData);
                }, 500);
            });
        }

        function generateMockData(endpoint, params) {
            // æ ¹æ®ç«¯ç‚¹ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
            const tableName = endpoint.split('?')[0];
            const search = params.search || '';
            const page = params.page || 1;
            const pageSize = params.pageSize || 10;
            
            const allData = generateMockTableData(tableName, 125);
            const filteredData = allData.filter(item => 
                Object.values(item).some(val => 
                    String(val).toLowerCase().includes(search.toLowerCase())
                )
            );
            
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            return {
                data: paginatedData,
                total: filteredData.length,
                page,
                pageSize
            };
        }

        function generateMockTableData(tableName, count) {
            const data = [];
            const baseId = (Math.random() * 1000).toString(36).substring(2, 8);
            
            for (let i = 1; i <= count; i++) {
                const record = { id: i };
                
                switch(tableName) {
                    case 'portfolios':
                        Object.assign(record, {
                            user_id: `user_${baseId}_${i}`,
                            name: `æŠ•èµ„ç»„åˆ ${i}`,
                            description: `è¿™æ˜¯ç¬¬ ${i} ä¸ªæŠ•èµ„ç»„åˆçš„æè¿°`,
                            base_currency: ['USD', 'EUR', 'GBP', 'JPY'][i % 4],
                            created_at: new Date(Date.now() - i * 86400000).toISOString()
                        });
                        break;
                        
                    case 'assets':
                        Object.assign(record, {
                            symbol: `SYM${i.toString().padStart(3, '0')}`,
                            name: `èµ„äº§ ${i}`,
                            asset_type: ['STOCK', 'BOND', 'ETF', 'REIT'][i % 4],
                            currency: 'USD',
                            exchange: ['NYSE', 'NASDAQ', 'LSE', 'TSE'][i % 4],
                            sector: ['ç§‘æŠ€', 'é‡‘è', 'åŒ»ç–—', 'èƒ½æº'][i % 4]
                        });
                        break;
                        
                    case 'holdings':
                        Object.assign(record, {
                            portfolio_id: (i % 5) + 1,
                            asset_id: (i % 20) + 1,
                            quantity: (Math.random() * 1000).toFixed(2),
                            average_cost: (Math.random() * 100).toFixed(2),
                            current_value: (Math.random() * 50000).toFixed(2),
                            currency: 'USD'
                        });
                        break;
                        
                    case 'transactions':
                        Object.assign(record, {
                            portfolio_id: (i % 5) + 1,
                            asset_id: (i % 20) + 1,
                            transaction_type: ['BUY', 'SELL'][i % 2],
                            quantity: (Math.random() * 100).toFixed(2),
                            price: (Math.random() * 100).toFixed(2),
                            transaction_date: new Date(Date.now() - i * 3600000).toISOString()
                        });
                        break;
                        
                    default:
                        // ä¸ºå…¶ä»–è¡¨ç”ŸæˆåŸºæœ¬æ•°æ®
                        Object.assign(record, {
                            name: `${tableName} è®°å½• ${i}`,
                            created_at: new Date(Date.now() - i * 86400000).toISOString()
                        });
                }
                
                data.push(record);
            }
            
            return data;
        }

        async function refreshTable() {
            const search = document.getElementById('search-input').value;
            showLoading(true);
            
            try {
                const response = await fetchData(CONFIG.currentTable, {
                    search: search,
                    page: CONFIG.currentPage,
                    pageSize: CONFIG.pageSize
                });
                
                displayTableData(response.data);
                updatePagination(response.total);
                updateTableInfo(response.total);
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayTableData(data) {
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100" class="text-center py-4">æ²¡æœ‰æ‰¾åˆ°è®°å½•</td></tr>';
                return;
            }
            
            // åˆ›å»ºè¡¨å¤´
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = formatFieldName(key);
                headerRow.appendChild(th);
            });
            
            // æ·»åŠ æ“ä½œåˆ—
            const actionsTh = document.createElement('th');
            actionsTh.textContent = 'æ“ä½œ';
            headerRow.appendChild(actionsTh);
            
            tableHeader.appendChild(headerRow);
            
            // åˆ›å»ºè¡¨æ•°æ®è¡Œ
            data.forEach(record => {
                const row = document.createElement('tr');
                
                Object.keys(record).forEach(key => {
                    const td = document.createElement('td');
                    td.textContent = formatFieldValue(key, record[key]);
                    row.appendChild(td);
                });
                
                // æ·»åŠ æ“ä½œæŒ‰é’®
                const actionsTd = document.createElement('td');
                actionsTd.className = 'table-actions';
                actionsTd.innerHTML = `
                    <button class="btn btn-sm btn-warning me-1" onclick="editRecord(${record.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="confirmDelete(${record.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                row.appendChild(actionsTd);
                
                tableBody.appendChild(row);
            });
        }

        function updatePagination(totalRecords) {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(totalRecords / CONFIG.pageSize);
            
            pagination.innerHTML = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${CONFIG.currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${CONFIG.currentPage - 1})">ä¸Šä¸€é¡µ</a>`;
            pagination.appendChild(prevLi);
            
            // é¡µç æŒ‰é’®
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === CONFIG.currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${CONFIG.currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${CONFIG.currentPage + 1})">ä¸‹ä¸€é¡µ</a>`;
            pagination.appendChild(nextLi);
        }

        function updateTableInfo(totalRecords) {
            const start = (CONFIG.currentPage - 1) * CONFIG.pageSize + 1;
            const end = Math.min(CONFIG.currentPage * CONFIG.pageSize, totalRecords);
            
            document.getElementById('table-info').textContent = 
                `æ˜¾ç¤ºç¬¬ ${start}-${end} æ¡è®°å½•ï¼Œå…± ${totalRecords} æ¡`;
        }

        function changePage(page) {
            CONFIG.currentPage = page;
            refreshTable();
        }

        function showLoading(show) {
            document.getElementById('table-loading').style.display = show ? 'block' : 'none';
            document.getElementById('data-table').style.display = show ? 'none' : 'table';
        }

        // è®°å½•æ“ä½œå‡½æ•°
        function showAddModal() {
            CONFIG.editingRecord = null;
            document.getElementById('modalTitle').textContent = `æ·»åŠ ${CONFIG.tables[CONFIG.currentTable].name}è®°å½•`;
            document.getElementById('saveButton').textContent = 'æ·»åŠ ';
            
            const formFields = document.getElementById('form-fields');
            formFields.innerHTML = generateFormFields();
            
            const modal = new bootstrap.Modal(document.getElementById('recordModal'));
            modal.show();
        }

        function editRecord(id) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä»APIè·å–è®°å½•æ•°æ®
            const record = generateMockTableData(CONFIG.currentTable, 1)[0];
            record.id = id;
            
            CONFIG.editingRecord = record;
            document.getElementById('modalTitle').textContent = `ç¼–è¾‘${CONFIG.tables[CONFIG.currentTable].name}è®°å½•`;
            document.getElementById('saveButton').textContent = 'æ›´æ–°';
            
            const formFields = document.getElementById('form-fields');
            formFields.innerHTML = generateFormFields(record);
            
            const modal = new bootstrap.Modal(document.getElementById('recordModal'));
            modal.show();
        }

        function generateFormFields(record = null) {
            const fields = CONFIG.tables[CONFIG.currentTable].fields;
            let html = '';
            
            fields.forEach(field => {
                if (field === 'id') return; // è·³è¿‡IDå­—æ®µ
                
                const value = record ? record[field] : '';
                const fieldName = formatFieldName(field);
                
                html += `
                    <div class="mb-3">
                        <label for="field-${field}" class="form-label">${fieldName}</label>
                        <input type="text" class="form-control" id="field-${field}" 
                               value="${value}" ${field === 'id' ? 'readonly' : ''}>
                    </div>
                `;
            });
            
            return html;
        }

        async function saveRecord() {
            const formData = {};
            const fields = CONFIG.tables[CONFIG.currentTable].fields;
            
            fields.forEach(field => {
                if (field === 'id') return;
                const input = document.getElementById(`field-${field}`);
                formData[field] = input.value;
            });
            
            try {
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨Supabase API
                if (CONFIG.editingRecord) {
                    // æ›´æ–°è®°å½•
                    console.log('æ›´æ–°è®°å½•:', CONFIG.editingRecord.id, formData);
                } else {
                    // æ·»åŠ è®°å½•
                    console.log('æ·»åŠ è®°å½•:', formData);
                }
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°è¡¨æ ¼
                bootstrap.Modal.getInstance(document.getElementById('recordModal')).hide();
                refreshTable();
                
                alert(CONFIG.editingRecord ? 'è®°å½•æ›´æ–°æˆåŠŸ!' : 'è®°å½•æ·»åŠ æˆåŠŸ!');
                
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        function confirmDelete(id) {
            document.getElementById('confirmDeleteButton').onclick = function() {
                deleteRecord(id);
            };
            
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        async function deleteRecord(id) {
            try {
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨Supabase API
                console.log('åˆ é™¤è®°å½•:', id);
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°è¡¨æ ¼
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                refreshTable();
                
                alert('è®°å½•åˆ é™¤æˆåŠŸ!');
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ¦‚è§ˆé¡µé¢å‡½æ•°
        async function refreshOverview() {
            // æ¨¡æ‹Ÿè·å–ç»Ÿè®¡æ•°æ®
            const stats = {
                totalPortfolios: 15,
                totalAssets: 243,
                totalHoldings: 567,
                totalTransactions: 892,
                totalValue: '1,234,567.89'
            };
            
            displayOverviewStats(stats);
            displayRecentTransactions();
            displayPortfolioDistribution();
        }

        function displayOverviewStats(stats) {
            const statsContainer = document.getElementById('stats-container');
            statsContainer.innerHTML = `
                <div class="col-md-2">
                    <div class="card stat-card">
                        <div class="number">${stats.totalPortfolios}</div>
                        <div class="label">æŠ•èµ„ç»„åˆ</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card stat-card">
                        <div class="number">${stats.totalAssets}</div>
                        <div class="label">èµ„äº§æ•°é‡</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card stat-card">
                        <div class="number">${stats.totalHoldings}</div>
                        <div class="label">æŒä»“è®°å½•</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card stat-card">
                        <div class="number">${stats.totalTransactions}</div>
                        <div class="label">äº¤æ˜“è®°å½•</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card">
                        <div class="number">$${stats.totalValue}</div>
                        <div class="label">æ€»èµ„äº§ä»·å€¼</div>
                    </div>
                </div>
            `;
        }

        function displayRecentTransactions() {
            const transactions = generateMockTableData('transactions', 5);
            const container = document.getElementById('recent-transactions');
            
            let html = '';
            transactions.forEach(transaction => {
                html += `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>${transaction.transaction_type === 'BUY' ? 'ä¹°å…¥' : 'å–å‡º'}</strong>
                            <small class="text-muted ms-2">èµ„äº§ ${transaction.asset_id}</small>
                        </div>
                        <div>
                            <span class="badge ${transaction.transaction_type === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                ${transaction.quantity} @ $${transaction.price}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function displayPortfolioDistribution() {
            const container = document.getElementById('portfolio-distribution');
            container.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-muted">ç»„åˆåˆ†å¸ƒå›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                    <small>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºé¥¼å›¾æˆ–æŸ±çŠ¶å›¾</small>
                </div>
            `;
        }

        // å·¥å…·å‡½æ•°
        function formatFieldName(fieldName) {
            const nameMap = {
                'id': 'ID',
                'user_id': 'ç”¨æˆ·ID',
                'name': 'åç§°',
                'description': 'æè¿°',
                'base_currency': 'åŸºå‡†è´§å¸',
                'symbol': 'ä»£ç ',
                'asset_type': 'èµ„äº§ç±»å‹',
                'currency': 'è´§å¸',
                'exchange': 'äº¤æ˜“æ‰€',
                'sector': 'è¡Œä¸š',
                'portfolio_id': 'ç»„åˆID',
                'asset_id': 'èµ„äº§ID',
                'quantity': 'æ•°é‡',
                'average_cost': 'å¹³å‡æˆæœ¬',
                'current_value': 'å½“å‰ä»·å€¼',
                'transaction_type': 'äº¤æ˜“ç±»å‹',
                'price': 'ä»·æ ¼',
                'transaction_date': 'äº¤æ˜“æ—¥æœŸ',
                'price_date': 'ä»·æ ¼æ—¥æœŸ',
                'from_currency': 'æºè´§å¸',
                'to_currency': 'ç›®æ ‡è´§å¸',
                'rate': 'æ±‡ç‡',
                'rate_date': 'æ±‡ç‡æ—¥æœŸ',
                'snapshot_date': 'å¿«ç…§æ—¥æœŸ',
                'classification': 'åˆ†ç±»',
                'status': 'çŠ¶æ€',
                'confidence_score': 'ç½®ä¿¡åº¦'
            };
            
            return nameMap[fieldName] || fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatFieldValue(fieldName, value) {
            if (value === null || value === undefined) return '-';
            
            if (fieldName.includes('date') || fieldName.includes('created') || fieldName.includes('updated')) {
                return new Date(value).toLocaleDateString('zh-CN');
            }
            
            if (fieldName.includes('value') || fieldName.includes('price') || fieldName.includes('cost')) {
                return typeof value === 'number' ? `$${value.toFixed(2)}` : value;
            }
            
            return String(value);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>