<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Outpost Inbox</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col max-w-md mx-auto shadow-xl">

    <div class="bg-blue-600 text-white p-4 sticky top-0 z-10 shadow-md flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center">
            <img src="https://cdn-icons-png.flaticon.com/512/1041/1041888.png" class="w-8 h-8 mr-2 bg-white rounded-full p-1">
            æ¶ˆæ¯ä¸­å¿ƒ
        </h1>
        <button id="refresh-btn" class="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded transition">åˆ·æ–°</button>
    </div>

    <div class="p-4 bg-white border-b">
        <div id="status-box" class="text-xs text-gray-400 font-mono mb-2 truncate">åˆå§‹åŒ–ä¸­...</div>
        <button id="enable-btn" class="w-full bg-blue-100 text-blue-700 font-semibold py-2 rounded-lg hover:bg-blue-200 transition mb-2">
            ğŸ”” å¼€å¯æ¨é€é€šçŸ¥
        </button>
        <button id="clear-btn" class="w-full text-gray-500 text-sm py-1 hover:text-red-500 transition">
            æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯
        </button>
    </div>

    <div id="inbox-list" class="flex-1 p-4 space-y-3 overflow-y-auto">
        <div class="text-center text-gray-400 py-10">æš‚æ— æ¶ˆæ¯</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";

        // --- é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXlqDll3KTeuwuE7bIpo6fMepouHHhILs",
            authDomain: "outpostmessageproxy.firebaseapp.com",
            projectId: "outpostmessageproxy",
            storageBucket: "outpostmessageproxy.firebasestorage.app",
            messagingSenderId: "788806511022",
            appId: "1:788806511022:web:0ccd2bb10d8eee8638403f"
        };
        const VAPID_KEY = "BI9komfQ5UJlo0MDBb2d_LwQKAsBv1IbZGWen2Vvp6dFK0bGi9xgraotcKT74PgiQGgOX-kaT200yfGNkEU8vR4";
        const API_URL = "https://us-central1-outpostmessageproxy.cloudfunctions.net/registerFcmToken";

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        // --- IndexedDB å·¥å…· ---
        const DB_NAME = 'OutpostPWA_DB';
        const STORE_NAME = 'inbox';

        const dbHelper = {
            open: () => {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    req.onsuccess = (e) => resolve(e.target.result);
                    req.onerror = (e) => reject(e);
                });
            },
            add: async (msg) => {
                const db = await dbHelper.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).add(msg);
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e);
                });
            },
            getAll: async () => {
                const db = await dbHelper.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const req = tx.objectStore(STORE_NAME).getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = (e) => reject(e);
                });
            },
            clear: async () => {
                const db = await dbHelper.open();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).clear();
                renderInbox(); // æ¸…ç©ºååˆ·æ–°UI
            }
        };

        // --- UI é€»è¾‘ ---
        const inboxList = document.getElementById('inbox-list');
        const statusBox = document.getElementById('status-box');
        
        function log(msg) {
            console.log(msg);
            statusBox.textContent = msg;
        }

        function formatTime(ts) {
            return new Date(ts).toLocaleString('zh-CN', { hour12: false, month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit' });
        }

        async function renderInbox() {
            const messages = await dbHelper.getAll();
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            messages.sort((a, b) => b.timestamp - a.timestamp);

            inboxList.innerHTML = '';
            
            if (messages.length === 0) {
                inboxList.innerHTML = '<div class="text-center text-gray-400 py-10 flex flex-col items-center"><span class="text-4xl mb-2">ğŸ“­</span>æš‚æ— æ¶ˆæ¯</div>';
                return;
            }

            messages.forEach(msg => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer active:bg-gray-50";
                card.onclick = () => {
                   if(msg.url && msg.url !== '/') window.location.href = msg.url;
                };

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-bold text-gray-800 text-base">${msg.title || 'æ— æ ‡é¢˜'}</h3>
                        <span class="text-xs text-gray-400 whitespace-nowrap ml-2">${formatTime(msg.timestamp)}</span>
                    </div>
                    <p class="text-gray-600 text-sm leading-relaxed">${msg.body || ''}</p>
                    ${msg.url && msg.url !== '/' ? '<div class="mt-2 text-xs text-blue-500 font-medium flex items-center">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… &rarr;</div>' : ''}
                `;
                inboxList.appendChild(card);
            });
        }

        // --- æ ¸å¿ƒä¸šåŠ¡ ---
        async function initMessaging() {
            try {
                // 1. æ³¨å†Œ SW
                const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js', { scope: './' });
                log('SW å°±ç»ª');

                // 2. åˆå§‹åŒ–åˆ—è¡¨
                renderInbox();

                // 3. æŒ‰é’®äº‹ä»¶
                document.getElementById('enable-btn').addEventListener('click', async () => {
                    log('è¯·æ±‚æƒé™...');
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') return log('æƒé™è¢«æ‹’ç»');

                    log('è·å– Token...');
                    const token = await getToken(messaging, { 
                        vapidKey: VAPID_KEY,
                        serviceWorkerRegistration: registration 
                    });

                    if (token) {
                        log('Token è·å–æˆåŠŸ');
                        sendTokenToBackend(token);
                    }
                });

                document.getElementById('clear-btn').onclick = dbHelper.clear;
                document.getElementById('refresh-btn').onclick = renderInbox;

                // 4. ç›‘å¬å‰å°æ¶ˆæ¯ (Appæ‰“å¼€æ—¶æ”¶åˆ°æ¶ˆæ¯)
                onMessage(messaging, async (payload) => {
                    log('æ”¶åˆ°æ–°æ¶ˆæ¯: ' + payload.notification.title);
                    
                    // ä¿å­˜åˆ°æ•°æ®åº“
                    await dbHelper.add({
                        title: payload.notification.title,
                        body: payload.notification.body,
                        url: payload.data?.url || '/',
                        timestamp: Date.now(),
                        read: true // å‰å°æ”¶åˆ°çš„ç®—æ˜¯å·²è¯»ï¼Ÿæˆ–è€…æœªè¯»ï¼Œçœ‹ä¸šåŠ¡
                    });

                    // ç«‹å³åˆ·æ–°åˆ—è¡¨ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ–°æ¶ˆæ¯å¼¹å‡º
                    renderInbox();
                });

                // 5. ç›‘å¬ IndexedDB å˜æ›´ (å¦‚æœåœ¨åå° SW å†™å…¥äº†æ•°æ®ï¼Œå‰å°éœ€è¦æ„ŸçŸ¥)
                // æ³¨æ„ï¼šIndexedDB æ²¡æœ‰åŸç”Ÿè·¨ Tab ç›‘å¬äº‹ä»¶ï¼Œè¿™é‡Œç”¨ focus ç®€å•æ¨¡æ‹Ÿåˆ·æ–°
                window.addEventListener('focus', renderInbox);

            } catch (err) {
                console.error(err);
                log('åˆå§‹åŒ–å¤±è´¥: ' + err.message);
            }
        }

        async function sendTokenToBackend(token) {
            // ... (ä¿æŒä½ ä¹‹å‰çš„ä¸ŠæŠ¥é€»è¾‘ä¸å˜) ...
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const platform = isIOS ? 'ios_pwa' : 'android_pwa';
            const userId = "demo_user_" + Math.floor(Math.random() * 1000); 
            
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, token, platform })
                });
                document.getElementById('enable-btn').innerText = "âœ… å·²è¿æ¥æœåŠ¡å™¨";
                document.getElementById('enable-btn').classList.add("bg-green-100", "text-green-700");
            } catch(e) { log('ä¸ŠæŠ¥å¤±è´¥'); }
        }

        if ('serviceWorker' in navigator) {
            initMessaging();
        }
    </script>
</body>
</html>