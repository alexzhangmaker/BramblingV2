<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Outpost Inbox</title>
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col max-w-md mx-auto shadow-xl">

    <div class="bg-blue-600 text-white p-4 sticky top-0 z-20 shadow-md flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center">
            <img src="https://cdn-icons-png.flaticon.com/512/1041/1041888.png" class="w-8 h-8 mr-2 bg-white rounded-full p-1">
            æ¶ˆæ¯ä¸­å¿ƒ
        </h1>
        <button id="refresh-btn" class="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded transition">åˆ·æ–°</button>
    </div>

    <div class="bg-blue-50 border-b border-blue-100 p-4">
        <label class="block text-xs font-bold text-blue-800 uppercase tracking-wide mb-1">
            é…ç½® User ID (å”¯ä¸€æ ‡è¯†)
        </label>
        <div class="flex space-x-2">
            <input id="userid-input" type="text" 
                class="flex-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md px-3 py-2" 
                placeholder="ä¾‹å¦‚: user_888 æˆ– alex@gmail.com">
            <button id="save-userid-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md text-sm transition shadow-sm whitespace-nowrap">
                ä¿å­˜
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-1" id="config-status">è¯·è¾“å…¥ ID ä»¥ç»‘å®šè®¾å¤‡</p>
    </div>

    <div class="p-4 bg-white border-b">
        <div id="status-box" class="text-xs text-gray-400 font-mono mb-2 truncate bg-gray-50 p-2 rounded">ç­‰å¾…åˆå§‹åŒ–...</div>
        <button id="enable-btn" class="w-full bg-gray-100 text-gray-600 font-semibold py-2 rounded-lg hover:bg-gray-200 transition mb-2">
            ğŸ”” å¼€å¯/æ›´æ–° æ¨é€æƒé™
        </button>
        <button id="clear-btn" class="w-full text-gray-400 text-xs py-1 hover:text-red-500 transition">
            æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯è®°å½•
        </button>
    </div>

    <div id="inbox-list" class="flex-1 p-4 space-y-3 overflow-y-auto pb-20">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";

        // --- é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXlqDll3KTeuwuE7bIpo6fMepouHHhILs",
            authDomain: "outpostmessageproxy.firebaseapp.com",
            projectId: "outpostmessageproxy",
            storageBucket: "outpostmessageproxy.firebasestorage.app",
            messagingSenderId: "788806511022",
            appId: "1:788806511022:web:0ccd2bb10d8eee8638403f"
        };
        const VAPID_KEY = "BI9komfQ5UJlo0MDBb2d_LwQKAsBv1IbZGWen2Vvp6dFK0bGi9xgraotcKT74PgiQGgOX-kaT200yfGNkEU8vR4";
        const API_URL = "https://us-central1-outpostmessageproxy.cloudfunctions.net/registerFcmToken";

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        // --- IndexedDB å·¥å…· (v2) ---
        const DB_NAME = 'OutpostPWA_DB';
        const DB_VERSION = 2; // âœ… å‡çº§ç‰ˆæœ¬
        const STORE_INBOX = 'inbox';
        const STORE_CONFIG = 'config';

        const dbHelper = {
            open: () => {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_INBOX)) {
                            db.createObjectStore(STORE_INBOX, { keyPath: 'id', autoIncrement: true });
                        }
                        // âœ… æ–°å¢ Config Store
                        if (!db.objectStoreNames.contains(STORE_CONFIG)) {
                            db.createObjectStore(STORE_CONFIG, { keyPath: 'key' });
                        }
                    };
                    req.onsuccess = (e) => resolve(e.target.result);
                    req.onerror = (e) => reject(e);
                });
            },
            // è·å– UserID
            getUserID: async () => {
                const db = await dbHelper.open();
                return new Promise((resolve) => {
                    const tx = db.transaction(STORE_CONFIG, 'readonly');
                    const req = tx.objectStore(STORE_CONFIG).get('userId');
                    req.onsuccess = () => resolve(req.result ? req.result.value : null);
                    req.onerror = () => resolve(null);
                });
            },
            // ä¿å­˜ UserID
            saveUserID: async (id) => {
                const db = await dbHelper.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_CONFIG, 'readwrite');
                    tx.objectStore(STORE_CONFIG).put({ key: 'userId', value: id });
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e);
                });
            },
            // æ¶ˆæ¯æ“ä½œ (ä¿æŒä¸å˜)
            addMsg: async (msg) => {
                const db = await dbHelper.open();
                const tx = db.transaction(STORE_INBOX, 'readwrite');
                tx.objectStore(STORE_INBOX).add(msg);
            },
            getAllMsg: async () => {
                const db = await dbHelper.open();
                return new Promise((resolve) => {
                    const req = db.transaction(STORE_INBOX, 'readonly').objectStore(STORE_INBOX).getAll();
                    req.onsuccess = () => resolve(req.result);
                });
            },
            clearMsg: async () => {
                const db = await dbHelper.open();
                const tx = db.transaction(STORE_INBOX, 'readwrite');
                tx.objectStore(STORE_INBOX).clear();
                tx.oncomplete = () => renderInbox();
            }
        };

        // --- UI é€»è¾‘ ---
        const inboxList = document.getElementById('inbox-list');
        const statusBox = document.getElementById('status-box');
        const userIdInput = document.getElementById('userid-input');
        const configStatus = document.getElementById('config-status');

        function log(msg) {
            console.log(msg);
            statusBox.textContent = msg;
        }

        function formatTime(ts) {
            return new Date(ts).toLocaleString('zh-CN', { hour12: false, month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit' });
        }

        async function renderInbox() {
            const messages = await dbHelper.getAllMsg();
            messages.sort((a, b) => b.timestamp - a.timestamp);
            inboxList.innerHTML = '';
            
            if (messages.length === 0) {
                inboxList.innerHTML = '<div class="text-center text-gray-400 py-10 flex flex-col items-center"><span class="text-4xl mb-2">ğŸ“­</span>æš‚æ— æ¶ˆæ¯</div>';
                return;
            }

            messages.forEach(msg => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer active:bg-gray-50";
                card.onclick = () => { if(msg.url && msg.url !== '/') window.location.href = msg.url; };
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-bold text-gray-800 text-base">${msg.title || 'æ— æ ‡é¢˜'}</h3>
                        <span class="text-xs text-gray-400 ml-2 whitespace-nowrap">${formatTime(msg.timestamp)}</span>
                    </div>
                    <p class="text-gray-600 text-sm leading-relaxed">${msg.body || ''}</p>
                    ${msg.url && msg.url !== '/' ? '<div class="mt-2 text-xs text-blue-500 font-medium">ç‚¹å‡»è¯¦æƒ… &rarr;</div>' : ''}
                `;
                inboxList.appendChild(card);
            });
        }

        // --- æ ¸å¿ƒæµç¨‹ ---
        let currentSWReg = null;

        async function initApp() {
            try {
                // 1. æ³¨å†Œ SW
                currentSWReg = await navigator.serviceWorker.register('./firebase-messaging-sw.js', { scope: './' });
                log('SW å°±ç»ª');

                // 2. åŠ è½½ UI æ•°æ®
                renderInbox();
                
                // 3. åŠ è½½å·²ä¿å­˜çš„ UserID
                const savedId = await dbHelper.getUserID();
                if (savedId) {
                    userIdInput.value = savedId;
                    configStatus.innerHTML = `<span class="text-green-600">âœ… å½“å‰ ID: ${savedId}</span>`;
                    configStatus.dataset.ready = "true";
                } else {
                    configStatus.innerHTML = `<span class="text-amber-500">âš ï¸ æœªè®¾ç½® IDï¼Œæ— æ³•ç²¾å‡†æ¥æ”¶æ¶ˆæ¯</span>`;
                }

                // 4. äº‹ä»¶ç»‘å®š
                document.getElementById('save-userid-btn').onclick = handleSaveConfig;
                document.getElementById('enable-btn').onclick = handleEnablePush;
                document.getElementById('clear-btn').onclick = dbHelper.clearMsg;
                document.getElementById('refresh-btn').onclick = renderInbox;

                // 5. ç›‘å¬å‰å°æ¶ˆæ¯
                onMessage(messaging, async (payload) => {
                    log('æ”¶åˆ°æ–°æ¶ˆæ¯: ' + payload.notification.title);
                    await dbHelper.addMsg({
                        title: payload.notification.title,
                        body: payload.notification.body,
                        url: payload.data?.url || '/',
                        timestamp: Date.now()
                    });
                    renderInbox();
                });
                window.addEventListener('focus', renderInbox);

            } catch (err) {
                log('Error: ' + err.message);
                console.error(err);
            }
        }

        // âœ… å¤„ç†ä¿å­˜é…ç½®
        async function handleSaveConfig() {
            const newId = userIdInput.value.trim();
            if (!newId) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ User ID");

            await dbHelper.saveUserID(newId);
            configStatus.innerHTML = `<span class="text-green-600">âœ… å·²ä¿å­˜! æ­£åœ¨é‡æ–°ç»‘å®š...</span>`;
            configStatus.dataset.ready = "true";
            
            // ä¿å­˜åå°è¯•è‡ªåŠ¨é‡æ–°ä¸ŠæŠ¥ Tokenï¼Œä»¥æ›´æ–°ç»‘å®šå…³ç³»
            handleEnablePush(); 
        }

        // âœ… å¤„ç†å¼€å¯/æ›´æ–°æ¨é€
        async function handleEnablePush() {
            // æ£€æŸ¥æ˜¯å¦è®¾ç½®äº† ID
            const userId = await dbHelper.getUserID();
            if (!userId) {
                alert("è¯·å…ˆåœ¨ä¸Šæ–¹è¾“å…¥å¹¶ä¿å­˜ User IDï¼");
                userIdInput.focus();
                return;
            }

            log('æ­£åœ¨åŒæ­¥...');
            try {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') return log('æƒé™è¢«æ‹’ç»');

                const token = await getToken(messaging, { 
                    vapidKey: VAPID_KEY,
                    serviceWorkerRegistration: currentSWReg 
                });

                if (token) {
                    await sendTokenToBackend(token, userId);
                }
            } catch (e) {
                log('å‡ºé”™: ' + e.message);
            }
        }

        // âœ… ä¸ŠæŠ¥ Token (å¸¦ä¸Š UserID)
        async function sendTokenToBackend(token, userId) {
            log(`æ­£åœ¨ç»‘å®šè®¾å¤‡åˆ°ç”¨æˆ·: ${userId}...`);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const platform = isIOS ? 'ios_pwa' : 'android_pwa';
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, token, platform })
                });
                
                if (res.ok) {
                    log(`âœ… ç»‘å®šæˆåŠŸ! ID: ${userId}`);
                    const btn = document.getElementById('enable-btn');
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.classList.add('bg-green-100', 'text-green-700');
                    btn.innerText = "âœ… è®¾å¤‡å·²è¿æ¥";
                } else {
                    log('ç»‘å®šå¤±è´¥');
                }
            } catch(e) { log('ç½‘ç»œé”™è¯¯'); }
        }

        if ('serviceWorker' in navigator) {
            initApp();
        }
    </script>
</body>
</html>